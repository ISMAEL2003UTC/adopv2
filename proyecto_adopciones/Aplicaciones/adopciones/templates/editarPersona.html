{% extends './plantilla.html' %}
{% load static %}
{% block body %}

<div class="container mt-5">
    <h2 class="text-center mb-4">Editar Persona</h2>

    <form id="formEditarPersona" method="POST" class="shadow p-4 rounded bg-light" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre:</label>
            <input type="text" id="nombre" name="nombre" class="form-control" value="{{ persona.nombre }}" required>
        </div>

        <div class="mb-3">
            <label for="apellido" class="form-label">Apellido:</label>
            <input type="text" id="apellido" name="apellido" class="form-control" value="{{ persona.apellido }}" required>
        </div>

        <div class="mb-3">
            <label for="telefono" class="form-label">Teléfono:</label>
            <input type="text" id="telefono" name="telefono" class="form-control" value="{{ persona.telefono|default:'' }}">
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">Email:</label>
            <input type="email" id="email" name="email" class="form-control" value="{{ persona.email|default:'' }}">
        </div>

        <div class="mb-3">
            <label for="direccion" class="form-label">Dirección:</label>
            <textarea id="direccion" name="direccion" class="form-control" rows="3">{{ persona.direccion|default:'' }}</textarea>
        </div>

        <div class="mb-3">
            <label for="imagen" class="form-label">Imagen:</label>
            <input id="imagen" name="imagen" type="file" class="file" data-show-preview="true" data-show-remove="true" data-show-upload="false">
            {% if persona.imagen %}
                <img src="{{ persona.imagen.url }}" alt="Foto" width="80" height="80" style="object-fit: cover; border-radius: 50%; margin-top: 10px;">
            {% endif %}
        </div>

        <div class="d-flex justify-content-between">
            <a href="{% url 'persona' %}" class="btn btn-secondary">Cancelar</a>
            <button type="button" class="btn btn-primary" onclick="confirmarEdicion();">Guardar Cambios</button>
        </div>
    </form>
</div>


<script>
function confirmarEdicion() {
    Swal.fire({
        title: '¿Desea guardar los cambios?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, guardar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#007bff',
        cancelButtonColor: '#d33'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('formEditarPersona').submit();
        }
    });
}
</script>


<script>
$(document).ready(function() {
    $.validator.addMethod("lettersonly", function(value, element) {
        return this.optional(element) || /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(value);
    }, "Solo se permiten letras");

    $("#formEditarPersona").validate({
        rules: {
            nombre: {
                required: true,
                minlength: 2,
                maxlength: 50,
                lettersonly: true
            },
            apellido: {
                required: true,
                minlength: 2,
                maxlength: 50,
                lettersonly: true
            },
            telefono: {
                digits: true,
                minlength: 10,
                maxlength: 10
            },
            email: {
                required: true,
                email: true
            },
            direccion: {
                required: true,
                minlength: 5,
                maxlength: 200
            },
            imagen: {
                extension: "jpg|jpeg|png"
            }
        },
        messages: {
            nombre: {
                required: "Ingrese el nombre",
                minlength: "El nombre debe tener al menos 2 caracteres",
                maxlength: "El nombre no debe exceder 50 caracteres",
                lettersonly: "Solo se permiten letras"
            },
            apellido: {
                required: "Ingrese el apellido",
                minlength: "El apellido debe tener al menos 2 caracteres",
                maxlength: "El apellido no debe exceder 50 caracteres",
                lettersonly: "Solo se permiten letras"
            },
            telefono: {
                digits: "Solo se permiten números",
                minlength: "El teléfono debe tener al menos 10 dígitos",
                maxlength: "El teléfono no debe exceder 10 dígitos"
            },
            email: {
                required: "Ingrese el correo electrónico",
                email: "Ingrese un correo válido"
            },
            direccion: {
                required: "Ingrese la dirección",
                minlength: "La dirección debe tener al menos 5 caracteres",
                maxlength: "La dirección no debe exceder 200 caracteres"
            },
            imagen: {
                extension: "Solo se permiten archivos JPG, JPEG o PNG"
            }
        },
        errorElement: "span",
        errorClass: "error text-danger",
        highlight: function(element) {
            $(element).addClass("is-invalid");
        },
        unhighlight: function(element) {
            $(element).removeClass("is-invalid");
        }
    });
});
</script>

<script>
$(document).ready(function() {
    $("#imagen").fileinput({
        language: 'es',
        allowedFileExtensions: ['jpg', 'jpeg', 'png'],
        maxFileSize: 2048, // 2 MB
        showPreview: true,
        showUpload: false,
        showRemove: true,
        initialPreviewAsData: true,
        theme: 'fas'
    });
});
</script>

{% endblock %}
