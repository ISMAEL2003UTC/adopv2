{% extends '../plantilla.html' %}
{% load static %}
{% block body %}
<div class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0"><i class="fas fa-book-medical me-2"></i> Crear Nueva Adopción</h2>
        <a href="/listar-adopciones" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i> Volver a la lista de adopciones
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">

            <form id="formAdopciones" action="/guardar-adopciones" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="mb-3">
                    <label for="persona" class="form-label">Nombre Persona</label>
                    <select name="personas" id="persona" class="form-select" required>
                        <option value="" selected disabled>Seleccione una Persona</option>
                        {% for persona in personas %}
                            <option value="{{ persona.id_persona }}">{{ persona.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="mascotas" class="form-label">Mascota</label>
                    <select name="mascotas" id="mascotas" class="form-select" required>
                        <option value="" selected disabled>Seleccione una Mascota</option>
                        {% for mascota in mascotas %}
                            <option value="{{ mascota.id_mascota }}">{{ mascota.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3 text-center">
                    <img id="previewMascota" src="" alt="Vista previa"
                         class="img-thumbnail d-none" style="max-width: 180px;">
                </div>

                <div class="mb-3">
                    <label for="fecha_adopcion" class="form-label">Fecha de Adopción</label>
                    <input type="date" name="fecha_adopcion" id="fecha_adopcion" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="observaciones" class="form-label">Observaciones</label>
                    <textarea name="observaciones" id="observaciones" rows="3" class="form-control" required></textarea>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i> Guardar
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>



<script>
$(document).ready(function() {

    $.validator.addMethod("noFuture", function(value, element) {
        const hoy = new Date();
        const fechaIngresada = new Date(value);
        return fechaIngresada <= hoy;
    }, "La fecha no puede ser futura.");

    $.validator.addMethod("minDate", function(value, element) {
        const min = new Date("2000-01-01");
        const fechaIngresada = new Date(value);
        return fechaIngresada >= min;
    }, "La fecha no puede ser anterior al año 2000.");

    $("#formAdopciones").validate({
        rules: {
            personas: { required: true },
            mascotas: { required: true },
            fecha_adopcion: {
                required: true,
                date: true,
                noFuture: true,
                minDate: true
            },
            observaciones: {
                required: true,
                minlength: 5
            }
        },
        messages: {
            personas: {
                required: "Por favor, seleccione una persona."
            },
            mascotas: {
                required: "Debe elegir una mascota."
            },
            fecha_adopcion: {
                required: "Debe ingresar la fecha de adopción.",
                date: "Ingrese una fecha válida.",
                noFuture: "La fecha no puede ser en el futuro.",
                minDate: "La fecha debe ser posterior al año 2000."
            },
            observaciones: {
                required: "Ingrese una observación sobre la adopción.",
                minlength: "Debe tener al menos 5 caracteres."
            }
        },
        errorElement: "div",
        errorClass: "text-danger mt-1",
        highlight: function(element) {
            $(element).addClass("is-invalid");
        },
        unhighlight: function(element) {
            $(element).removeClass("is-invalid");
        }
    });

    const mascotasData = {
        {% for mascota in mascotas %}
            "{{ mascota.id_mascota }}": "{% if mascota.foto %}{{ mascota.foto.url }}{% else %}/static/sin_foto.png{% endif %}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    $("#mascotas").change(function () {
        const id = $(this).val();
        const imagen = mascotasData[id];

        if (imagen) {
            $("#previewMascota")
                .attr("src", imagen)
                .removeClass("d-none");
        } else {
            $("#previewMascota").addClass("d-none");
        }
    });

});
</script>

{% endblock %}
